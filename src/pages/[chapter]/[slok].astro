---
import { getCollection } from "astro:content";

import BaseHead from "../../base/BaseHead.astro";
import MobileLayout from "../../base/layouts/MobileLayout.astro";
import { getEntry } from "astro:content";
import GotoButton from "../../base/GotoButton.astro";
import { padToThree } from "../../utils/padToThree";

import SocialShare from "../../components/SocialShare.astro";

export async function getStaticPaths() {
  const sloks = await getCollection("sloks");

  return sloks.map((item) => ({
    params: {
      chapter: item.data.chapter_number.toString(),
      slok: item.data.verse_number.toString(),
    },
    props: { slok: item },
  }));
}

const { slok } = Astro.props;
const translations = (
  await getEntry(
    "translations",
    `${slok.data.chapter_number}/${slok.data.verse_number}`,
  )
)?.data;

const commentaries = (
  await getEntry(
    "commentary",
    `${slok.data.chapter_number}/${slok.data.verse_number}`,
  )
)?.data;
---

<BaseHead
  description={`Read Bhagavad Gita ${slok.data.chapter_number}.${slok.data.verse_number} in Sanskrit with English meaning. Understand the verse's message and its spiritual significance as explained by Lord Krishna.`}
  title={`Bhagavad Gita ${slok.data.chapter_number}.${slok.data.verse_number} - Slokas with meaning`}
>
  <MobileLayout>
    <article class="max-w-3xl mx-auto px-4 py-6 space-y-10">
      <GotoButton
        transition_name={`chapter-${slok.data.chapter_number}`}
        name="Go to Chapter"
        href={`/${slok.data.chapter_number}`}
      />
      <!-- Verse Header -->
      <header class="text-center space-y-2">
        <h2
          transition:name={`slok-name-${slok.id}`}
          class="text-sm tracking-widest uppercase"
          style="color: var(--color-text-muted)"
        >
          Bhagavad Gita
        </h2>
        <h1 class="text-3xl font-semibold text-primary">
          {slok.data.chapter_number}.{slok.data.verse_number}
        </h1>
      </header>

      <!-- Sanskrit -->
      <section class="text-center space-y-4">
        {
          slok.data.text.includes("\n") ? (
            <p
              class="text-xl md:text-2xl leading-relaxed font-medium text-sanskrit"
              set:html={slok.data.text.split("\n\n").join("<br/>")}
            />
          ) : (
            <p
              class="text-xl md:text-2xl leading-relaxed font-medium text-sanskrit"
              set:html={slok.data.text.replace("।", " । <br/>")}
            />
          )
        }
        <p
          class="text-base italic leading-loose"
          style="color: var(--color-text-muted)"
          set:html={slok.data.transliteration
            .normalize("NFKD")
            .split("\n")
            .join("<br/>")}
        />
      </section>
      <audio
        class="prose"
        autoplay
        src={`https://gita-audio.jkyog.org/audio/sanskrit/gita_audios/${padToThree(slok.data.chapter_number)}_${padToThree(slok.data.verse_number)}.mp3`}
      ></audio>

      <!-- Divider -->
      <div class="flex items-center gap-4">
        <span class="flex-1 h-px bg-border"></span>
        <span
          class="text-xs tracking-widest"
          style="color: var(--color-text-muted)">◆</span
        >
        <span class="flex-1 h-px bg-border"></span>
      </div>

      <!-- Synonyms -->
      <section class="space-y-3">
        <h3 class="text-lg font-semibold text-primary text-center">
          Word Meanings
        </h3>

        <div
          class="relative overflow-x-auto bg-neutral-primary-soft shadow-xs rounded-base border border-default"
        >
          <table class="w-full text-sm text-left rtl:text-right text-body">
            <thead class="bg-neutral-secondary-soft border-b border-default">
              <tr>
                <th scope="col" class="px-6 py-3 font-medium"> Word </th>
                <th scope="col" class="px-6 py-3 font-medium"> Meaning </th>
              </tr>
            </thead>
            <tbody>
              {
                slok.data.word_meanings?.split(";").map((m) => (
                  <tr class="odd:bg-neutral-primary even:bg-neutral-secondary-soft border-b border-default">
                    <th
                      scope="row"
                      class="px-6 py-4 font-medium text-heading whitespace-nowrap"
                    >
                      {m.split("—")[0]}
                    </th>
                    <td class="px-6 py-4"> {m.split("—")[1]}</td>
                  </tr>
                ))
              }
            </tbody>
          </table>
        </div>
      </section>
      <!-- Translation -->
      {
        translations && translations.length > 0 && (
          <section class="space-y-4">
            <h3 class="text-lg font-semibold text-primary text-center">
              Translation
            </h3>

            <div class="max-w-sm mx-auto">
              <select
                id="translationSelector"
                class="w-full rounded border bg-surface px-3 py-2 text-sm focus:ring-2 focus:ring-primary/40"
              >
                {translations.map((t, i) => (
                  <option selected={i === 0} value={t.author_id}>
                    {t.authorName}
                  </option>
                ))}
              </select>
            </div>

            <p
              id="translationPara"
              class="text-base leading-loose text-justify"
              style="color: var(--color-text-primary)"
              set:html={translations[0].description}
            />
          </section>
        )
      }

      <!-- Commentary -->
      {
        commentaries && commentaries.length > 0 && (
          <section class="space-y-4">
            <h3 class="text-lg font-semibold text-primary text-center">
              Commentary
            </h3>

            <div class="max-w-sm mx-auto">
              <select
                id="commentarySelector"
                class="w-full rounded border bg-surface px-3 py-2 text-sm focus:ring-2 focus:ring-primary/40"
              >
                {commentaries.map((c, i) => (
                  <option selected={i === 0} value={c.author_id}>
                    {c.authorName} {c.lang && `(${c.lang})`}
                  </option>
                ))}
              </select>
            </div>

            <p
              id="commentaryPara"
              class="text-base leading-loose text-justify"
              style="color: var(--color-text-primary)"
              set:html={commentaries[0].description}
            />
          </section>
        )
      }
    </article>
  </MobileLayout>

  <SocialShare  />
</BaseHead>

<script
  type="application/json"
  id="translations-data"
  set:html={JSON.stringify(translations ?? [])}
/>
<script
  type="application/json"
  id="commentaries-data"
  set:html={JSON.stringify(commentaries ?? [])}
/>

<script>


document.addEventListener("astro:page-load", () => {






  const translationSelector = document.getElementById("translationSelector");
  const translationPara = document.getElementById("translationPara");
  const commentarySelector = document.getElementById("commentarySelector");
  const commentaryPara = document.getElementById("commentaryPara");

  const translations = JSON.parse(
    document.getElementById("translations-data")?.textContent || "[]",
  );

  const commentaries = JSON.parse(
    document.getElementById("commentaries-data")?.textContent || "[]",
  );

  translationSelector?.addEventListener("change", (e) => {
    // @ts-ignore
    const authorId = Number(e.target.value);

    // @ts-ignore
    const translation = translations.find((t) => t.author_id === authorId);

    if (translation && translationPara) {
      translationPara.innerHTML = translation.description;
    }
  });

  commentarySelector?.addEventListener("change", (e) => {
    // @ts-ignore
    const authorId = Number(e.target.value);

    // @ts-ignore
    const commentary = commentaries.find((c) => c.author_id === authorId);

    if (commentary && commentaryPara) {
      commentaryPara.innerHTML = commentary.description;
    }
  });
  });


</script>
